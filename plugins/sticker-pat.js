import fs from 'fs';

// ğŸ”¹ Ù…Ù„Ù ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
const FILE_PATH = './welcomeGroups.json';

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
let welcomeGroups = new Set();
if (fs.existsSync(FILE_PATH)) {
    try {
        const data = JSON.parse(fs.readFileSync(FILE_PATH, 'utf-8'));
        welcomeGroups = new Set(data);
    } catch (error) {
        console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØªØ±Ø­ÙŠØ¨:", error);
    }
}

// ğŸ”¹ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù„Ù
const saveWelcomeGroups = () => {
    fs.writeFileSync(FILE_PATH, JSON.stringify([...welcomeGroups]), 'utf-8');
};

// ğŸ”¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ±Ø­ÙŠØ¨
let handler = async (m, { conn, isAdmin, text }) => {
    if (!m.isGroup) 
        return conn.sendMessage(m.chat, { text: "âŒ *Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª!*" }, { quoted: m });

    if (!isAdmin) 
        return conn.sendMessage(m.chat, { text: "ğŸš« *ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø´Ø±ÙÙ‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±!*" }, { quoted: m });

    if (text === "Ø§ÙŠÙ‚Ø§Ù") {
        if (!welcomeGroups.has(m.chat)) 
            return conn.sendMessage(m.chat, { text: "âš ï¸ *Ø§Ù„ØªØ±Ø­ÙŠØ¨ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!*" }, { quoted: m });

        welcomeGroups.delete(m.chat);
        saveWelcomeGroups(); // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        return conn.sendMessage(m.chat, { text: "ğŸ›‘ *ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.*" }, { quoted: m });
    }

    if (welcomeGroups.has(m.chat)) {
        return conn.sendMessage(m.chat, { text: "âš ï¸ *Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…ÙØ¹Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!*" }, { quoted: m });
    }

    welcomeGroups.add(m.chat);
    saveWelcomeGroups(); // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
    return conn.sendMessage(m.chat, { text: "ØªØ³Øª Ø§Ù„Ø£Ù† Ø´ØºØ§Ù„ ÙŠØ§ Ø­Ø¨" }, { quoted: m });
};

handler.command = /^(ØªØ±Ø­ÙŠØ¨|Ø§ÙŠÙ‚Ø§Ù)$/i;
handler.group = true;
handler.admin = true;

export default handler;

// ğŸ”¹ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
global.conn.ev.on("group-participants.update", async (update) => {
    const { id, participants, action } = update;

    if (!welcomeGroups.has(id) || action !== "add") return;

    let imageUrl = 'https://qu.ax/LQfVY.png'; // ØµÙˆØ±Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨

    try {
        let groupMetadata = await global.conn.groupMetadata(id);
        let groupDescription = groupMetadata.desc || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.";

        for (let participant of participants) {
            let username = `@${participant.split("@")[0]}`;
            let welcomeText = `*â•­â”ˆâŠ°* ğŸª»Ø§Ù„Ù€Ù€ØªÙ€Ù€Ø±Ø­Ù€Ù€ÙŠÙ€Ù€Ø¨ğŸª» *âŠ°â”ˆ âœ¦*\n`
                + `*â”ŠË¹ğŸ“¯Ë¼â”Š Ù…Ù€Ø±Ø­Ø¨Ù€Ø§Ù‹ Ø¨Ù€Ù€Ùƒ*\n`
                + `â”ŠË¹ğŸ¥·ğŸ»Ë¼â”Š ${username}\n`
                + `â”ŠğŸ“© *Ø§Ù‚Ù€Ù€Ø±Ø£ ÙˆØµÙ€Ù€Ù Ø§Ù„Ù€Ù€Ù…Ù€Ù€Ø¬Ù€Ù€Ù…Ù€Ù€ÙˆØ¹Ù€Ù€Ø©*\n`
                  + `> *Ù…Ù€Ù€Ù†Ù€Ù€ÙˆØ± Ø§Ù„Ù€Ù€Ù‚Ù€Ù€Ø±ÙˆØ¨ Ø§Ù†Ù€Ù€Ø§ Ù„Ù€ÙˆÙŠÙ€Ø¯â”ŠË¹ğŸ’¸Ë¼â”Š*\n\n`
                  + `â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€â€`
                
                + `*ğŸ‘‡ğŸ»*\n\n`
                + `> *Ù…Ù€Ù€Ù†Ù€Ù€ÙˆØ± Ø§Ù„Ù€Ù€Ù‚Ù€Ù€Ø±ÙˆØ¨ Ø§Ù†Ù€Ù€Ø§ Ù„Ù€ÙˆÙŠÙ€Ø¯â”ŠË¹ğŸ’¸Ë¼â”Š*\n\n`
                + `ğŸ“œ *Ø§Ù„Ù€Ù€ÙˆØµÙ€Ù€Ù:*\n${groupDescription}`;

            let message = {
                image: { url: imageUrl },
                caption: welcomeText,
                mentions: [participant],
                footer: 'ğ‹ğğ˜ğƒ-ğğğ“',
            };

            await global.conn.sendMessage(id, message);
        }
    } catch (e) {
        console.log("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨:", e);
    }
});
